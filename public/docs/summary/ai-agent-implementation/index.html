<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="KẾ HOẠCH TRIỂN KHAI AI AGENT#
Hệ Thống Gợi Ý Công Thức Thông Minh
TỔNG QUAN#
Tính năng: AI Agent gợi ý món ăn thông minh dựa trên:

Thông tin cá nhân (giới tính, tuổi, quốc gia)
Sở thích ẩm thực (món canh, món chiên, món hấp…)
Nguyên liệu nhập đơn giản (chỉ tên, không quản lý số lượng/hạn dùng)

Phạm vi:

✅ User nhập danh sách nguyên liệu
✅ System check nguyên liệu hợp lệ
✅ Gợi ý 4 món từ database &#43; 1 món AI tạo mới
✅ Auto-approval công thức dựa trên rating (&gt;= 4 sao)
✅ Error handling cho nguyên liệu không hợp lệ

Thời gian: 2 tuần (Tuần 3-4 trong deployment plan)">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://example.org/docs/summary/ai-agent-implementation/">
  <meta property="og:site_name" content="Together">
  <meta property="og:title" content="Kế Hoạch Triển Khai AI Agent">
  <meta property="og:description" content="KẾ HOẠCH TRIỂN KHAI AI AGENT#Hệ Thống Gợi Ý Công Thức Thông Minh
TỔNG QUAN#Tính năng: AI Agent gợi ý món ăn thông minh dựa trên:
Thông tin cá nhân (giới tính, tuổi, quốc gia) Sở thích ẩm thực (món canh, món chiên, món hấp…) Nguyên liệu nhập đơn giản (chỉ tên, không quản lý số lượng/hạn dùng) Phạm vi:
✅ User nhập danh sách nguyên liệu ✅ System check nguyên liệu hợp lệ ✅ Gợi ý 4 món từ database &#43; 1 món AI tạo mới ✅ Auto-approval công thức dựa trên rating (&gt;= 4 sao) ✅ Error handling cho nguyên liệu không hợp lệ Thời gian: 2 tuần (Tuần 3-4 trong deployment plan)">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
<title>Kế Hoạch Triển Khai AI Agent | Together</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://example.org/docs/summary/ai-agent-implementation/">
<link rel="stylesheet" href="/book.min.d124d6c76b11546b04023ef152f0ca77dd5bfd00e1638c75250d60e274cdc189.css" integrity="sha256-0STWx2sRVGsEAj7xUvDKd91b/QDhY4x1JQ1g4nTNwYk=" crossorigin="anonymous">


  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.a12a0edc5979b40b3a21762e87b6bf03e2526b9cde0291a4eb1be5a9403b30b3.js" integrity="sha256-oSoO3Fl5tAs6IXYuh7a/A&#43;JSa5zeApGk6xvlqUA7MLM=" crossorigin="anonymous"></script>

  
</head>
<body dir="ltr" class="book-kind-page book-type-docs">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Together</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>














  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/summary/" class="">
      Summary</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/summary/aws-services-diagram/" class="">
      AWS Services Architecture Diagram</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/summary/ai-agent-implementation/" class="active">
      Kế Hoạch Triển Khai AI Agent</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/summary/database-diagram/" class="">
      Database Schema Diagram</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/summary/cost-analysis/" class="">
      Phân Tích Chi Phí</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/" class="">
      AI DLC</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/00-overview/" class="">
      00 - Project Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/01-requirements/" class="">
      01 - Requirements</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/02-constraints/" class="">
      02 - Constraints</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/10-architecture/" class="">
      10 - Architecture</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/11-database/" class="">
      11 - Database Design</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/12-api-spec/" class="">
      12 - API Specification</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/13-security/" class="">
      13 - Security</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/14-ai-agent/" class="">
      14 - AI Agent Design</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/20-backend/" class="">
      20 - Backend Implementation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/21-frontend/" class="">
      21 - Frontend Implementation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/22-devops/" class="">
      22 - DevOps &amp; Deployment</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/23-tasks/" class="">
      23 - Implementation Tasks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/30-cost-analysis/" class="">
      30 - Cost Analysis</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/31-scaling/" class="">
      31 - Scaling Strategy</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/32-monitoring/" class="">
      32 - Monitoring &amp; Observability</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/40-auth/" class="">
      40 - Authentication &amp; Authorization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/41-privacy/" class="">
      41 - Privacy &amp; Data Protection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/42-compliance/" class="">
      42 - Compliance &amp; Governance</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/99-glossary/" class="">
      99 - Glossary</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dlc/99-references/" class="">
      99 - References</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>













</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Kế Hoạch Triển Khai AI Agent</h3>

  <label for="toc-control">
    
    <img src="/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#tổng-quan">TỔNG QUAN</a></li>
    <li><a href="#luồng-người-dùng">LUỒNG NGƯỜI DÙNG</a>
      <ul>
        <li><a href="#flow-1-gợi-ý-món-ăn-thông-minh-smart-suggestion">Flow 1: Gợi Ý Món Ăn Thông Minh (Smart Suggestion)</a></li>
        <li><a href="#flow-2-auto-approval-công-thức-rating-based">Flow 2: Auto-Approval Công Thức (Rating-based)</a></li>
        <li><a href="#flow-3-error-handling---nguyên-liệu-không-hợp-lệ">Flow 3: Error Handling - Nguyên Liệu Không Hợp Lệ</a></li>
      </ul>
    </li>
    <li><a href="#triển-khai-kỹ-thuật">TRIỂN KHAI KỸ THUẬT</a>
      <ul>
        <li><a href="#kiến-trúc-tables--relationships">Kiến Trúc Tables &amp; Relationships</a></li>
        <li><a href="#backend-nodejs-20-lambda-functions">Backend: Node.js 20 Lambda Functions</a></li>
        <li><a href="#cơ-sở-dữ-liệu-amazon-dynamodb">Cơ Sở Dữ Liệu: Amazon DynamoDB</a></li>
        <li><a href="#api-endpoints">API Endpoints</a></li>
      </ul>
    </li>
    <li><a href="#quyền-riêng-tư--bảo-mật">QUYỀN RIÊNG TƯ &amp; BẢO MẬT</a>
      <ul>
        <li><a href="#các-mức-quyền-riêng-tư">Các Mức Quyền Riêng Tư</a></li>
        <li><a href="#thuộc-tính-được-kiểm-soát-quyền-riêng-tư">Thuộc Tính Được Kiểm Soát Quyền Riêng Tư</a></li>
        <li><a href="#kiểm-soát-truy-cập-theo-vai-trò">Kiểm Soát Truy Cập Theo Vai Trò</a></li>
      </ul>
    </li>
    <li><a href="#thời-gian--mốc-quan-trọng">Thời Gian &amp; Mốc Quan Trọng</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="kế-hoạch-triển-khai-ai-agent">KẾ HOẠCH TRIỂN KHAI AI AGENT<a class="anchor" href="#k%e1%ba%bf-ho%e1%ba%a1ch-tri%e1%bb%83n-khai-ai-agent">#</a></h1>
<p>Hệ Thống Gợi Ý Công Thức Thông Minh</p>
<h2 id="tổng-quan">TỔNG QUAN<a class="anchor" href="#t%e1%bb%95ng-quan">#</a></h2>
<p><strong>Tính năng</strong>: AI Agent gợi ý món ăn thông minh dựa trên:</p>
<ul>
<li>Thông tin cá nhân (giới tính, tuổi, quốc gia)</li>
<li>Sở thích ẩm thực (món canh, món chiên, món hấp…)</li>
<li>Nguyên liệu nhập đơn giản (chỉ tên, không quản lý số lượng/hạn dùng)</li>
</ul>
<p><strong>Phạm vi:</strong></p>
<ul>
<li>✅ User nhập danh sách nguyên liệu</li>
<li>✅ System check nguyên liệu hợp lệ</li>
<li>✅ Gợi ý 4 món từ database + 1 món AI tạo mới</li>
<li>✅ Auto-approval công thức dựa trên rating (&gt;= 4 sao)</li>
<li>✅ Error handling cho nguyên liệu không hợp lệ</li>
</ul>
<p><strong>Thời gian</strong>: 2 tuần (Tuần 3-4 trong deployment plan)</p>
<h2 id="luồng-người-dùng">LUỒNG NGƯỜI DÙNG<a class="anchor" href="#lu%e1%bb%93ng-ng%c6%b0%e1%bb%9di-d%c3%b9ng">#</a></h2>
<h3 id="flow-1-gợi-ý-món-ăn-thông-minh-smart-suggestion">Flow 1: Gợi Ý Món Ăn Thông Minh (Smart Suggestion)<a class="anchor" href="#flow-1-g%e1%bb%a3i-%c3%bd-m%c3%b3n-%c4%83n-th%c3%b4ng-minh-smart-suggestion">#</a></h3>
<pre tabindex="0"><code>┌─────────────────────────────────────────────────────────┐
│                    ĐẦU VÀO NGƯỜI DÙNG                   │
├─────────────────────────────────────────────────────────┤
│  Người dùng A:                                          │
│  • Nam, 1990 (34 tuổi), Vietnam                        │
│  • Thích ăn: canh, món hấp                             │
│  • Nguyên liệu nhập: Cá rô, bông súng, gừng, hành     │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              VALIDATE &amp; PROCESS                         │
├─────────────────────────────────────────────────────────┤
│  1. Check nguyên liệu hợp lệ:                          │
│     ✅ &#34;Cá rô&#34; → Có trong database                      │
│     ✅ &#34;Bông súng&#34; → Có trong database                  │
│     ✅ &#34;Gừng&#34; → Có trong database                       │
│     ✅ &#34;Hành&#34; → Có trong database                       │
│                                                         │
│  2. Tìm công thức:                                     │
│     - Query DynamoDB: 4 món match nguyên liệu          │
│     - Gọi AI Bedrock: 1 món mới sáng tạo               │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              KẾT QUẢ GỢI Ý (5 MÓN)                     │
├─────────────────────────────────────────────────────────┤
│     Từ Database (4 món):                               │
│  1. Canh cá rô nấu bông súng                           │
│  2. Cá rô kho gừng                                      │
│  3. Canh bông súng                                      │
│  4. Cá rô chiên                                         │
│                                                         │
│     AI Generated (1 món mới):                          │
│  5. Cá rô hấp bông súng gừng hành                      │
│     (Món độc đáo từ AI)                                │
└─────────────────────────────────────────────────────────┘</code></pre><h3 id="flow-2-auto-approval-công-thức-rating-based">Flow 2: Auto-Approval Công Thức (Rating-based)<a class="anchor" href="#flow-2-auto-approval-c%c3%b4ng-th%e1%bb%a9c-rating-based">#</a></h3>
<pre tabindex="0"><code>┌─────────────────────────────────────────────────────────┐
│              USER NẤU MÓN AI TẠO                        │
├─────────────────────────────────────────────────────────┤
│  1. User chọn món: &#34;Cá rô hấp bông súng gừng hành&#34;    │
│  2. Làm theo hướng dẫn                                 │
│  3. Click &#34;Hoàn thành&#34;                                 │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              ĐÁNH GIÁ CÔNG THỨC                         │
├─────────────────────────────────────────────────────────┤
│  Popup hiển thị:                                        │
│  • Rating: ⭐⭐⭐⭐⭐ (1-5 sao)                           │
│  • Comment: &#34;Món này rất ngon!&#34;                        │
│  • Submit                                               │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              XỬ LÝ RATING                               │
├─────────────────────────────────────────────────────────┤
│  IF rating &gt;= 4 sao:                                   │
│    ✅ Set recipe.is_approved = true                     │
│    ✅ Add to public recipes database                    │
│    ✅ Notify: &#34;Công thức đã được thêm vào database!&#34;   │
│                                                         │
│  ELSE (rating &lt; 4 sao):                                │
│    ℹ️ Notify: &#34;Cảm ơn đánh giá của bạn!&#34;              │
│    ❌ Không thêm vào database                           │
└─────────────────────────────────────────────────────────┘</code></pre><h3 id="flow-3-error-handling---nguyên-liệu-không-hợp-lệ">Flow 3: Error Handling - Nguyên Liệu Không Hợp Lệ<a class="anchor" href="#flow-3-error-handling---nguy%c3%aan-li%e1%bb%87u-kh%c3%b4ng-h%e1%bb%a3p-l%e1%bb%87">#</a></h3>
<pre tabindex="0"><code>┌─────────────────────────────────────────────────────────┐
│              USER NHẬP NGUYÊN LIỆU SAI                  │
├─────────────────────────────────────────────────────────┤
│  Input: &#34;abc xyz&#34;, &#34;123&#34;, &#34;thit ga&#34;                    │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              VALIDATE TỪNG NGUYÊN LIỆU                  │
├─────────────────────────────────────────────────────────┤
│  1. &#34;abc xyz&#34; → ❌ Không tồn tại                        │
│     → Fuzzy search: Tìm nguyên liệu gần đúng           │
│     → Gợi ý: &#34;Bạn có muốn: [gà, cá, bò]?&#34;             │
│                                                         │
│  2. &#34;123&#34; → ❌ Format không hợp lệ                      │
│     → Error: &#34;Tên nguyên liệu không hợp lệ&#34;            │
│                                                         │
│  3. &#34;thit ga&#34; → ✅ Fuzzy match: &#34;thịt gà&#34;              │
│     → Auto-correct: &#34;Bạn muốn dùng &#39;thịt gà&#39;?&#34;         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              ERROR RESPONSES                            │
├─────────────────────────────────────────────────────────┤
│  Case 1: Nguyên liệu không tồn tại                     │
│  → HTTP 400: {                                          │
│      &#34;error&#34;: &#34;ingredient_not_found&#34;,                   │
│      &#34;message&#34;: &#34;Không tìm thấy nguyên liệu: abc xyz&#34;, │
│      &#34;suggestions&#34;: [&#34;gà&#34;, &#34;cá&#34;, &#34;bò&#34;]                 │
│    }                                                    │
│                                                         │
│  Case 2: Format không hợp lệ                           │
│  → HTTP 400: {                                          │
│      &#34;error&#34;: &#34;invalid_format&#34;,                         │
│      &#34;message&#34;: &#34;Tên nguyên liệu không hợp lệ: 123&#34;   │
│    }                                                    │
│                                                         │
│  Case 3: Quá ít nguyên liệu                            │
│  → HTTP 400: {                                          │
│      &#34;error&#34;: &#34;insufficient_ingredients&#34;,               │
│      &#34;message&#34;: &#34;Cần ít nhất 2 nguyên liệu&#34;           │
│    }                                                    │
│                                                         │
│  Case 4: Fuzzy match thành công                        │
│  → HTTP 200: {                                          │
│      &#34;corrected&#34;: true,                                 │
│      &#34;original&#34;: &#34;thit ga&#34;,                             │
│      &#34;matched&#34;: &#34;thịt gà&#34;,                              │
│      &#34;confidence&#34;: 0.85                                 │
│    }                                                    │
└─────────────────────────────────────────────────────────┘</code></pre><h2 id="triển-khai-kỹ-thuật">TRIỂN KHAI KỸ THUẬT<a class="anchor" href="#tri%e1%bb%83n-khai-k%e1%bb%b9-thu%e1%ba%adt">#</a></h2>
<h3 id="kiến-trúc-tables--relationships">Kiến Trúc Tables &amp; Relationships<a class="anchor" href="#ki%e1%ba%bfn-tr%c3%bac-tables--relationships">#</a></h3>
<p><strong>Các Tables Liên Kết:</strong></p>
<pre tabindex="0"><code>master_ingredients (nguyên liệu chuẩn)
          ↓
    [VALIDATE]
          ↓
user_ingredients (nguyên liệu người dùng nhập)
          ↓
    [QUERY &amp; MATCH]
          ↓
    ┌─────────────────┬─────────────────┐
    ↓                 ↓                 ↓
recipes          user_data      user_preferences
(is_approved)    (sở thích)     (năm sinh, giới tính, quốc gia)
    ↓                 ↓                 ↓
    └─────────────────┴─────────────────┘
                      ↓
              [AI AGENT PROMPT]
                      ↓
            ┌─────────────────┐
            ↓                 ↓
    Database Recipes    AI Generated Recipe
    (4 món phù hợp)     (1 món sáng tạo)</code></pre><h3 id="backend-nodejs-20-lambda-functions">Backend: Node.js 20 Lambda Functions<a class="anchor" href="#backend-nodejs-20-lambda-functions">#</a></h3>
<p><strong>Lambda AI Suggestion Engine:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Sử dụng AWS SDK v3 cho Bedrock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">BedrockRuntimeClient</span>, <span style="color:#a6e22e">InvokeModelCommand</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;@aws-sdk/client-bedrock-runtime&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">DynamoDBClient</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;@aws-sdk/client-dynamodb&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">DynamoDBDocumentClient</span>, <span style="color:#a6e22e">QueryCommand</span>, <span style="color:#a6e22e">PutCommand</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;@aws-sdk/lib-dynamodb&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ddb</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">DynamoDBDocumentClient</span>.<span style="color:#a6e22e">from</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DynamoDBClient</span>({}));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Flow mới:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 1. Validate ingredients với master_ingredients table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. Query 4 recipes từ DynamoDB (is_approved=true)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 3. Generate 1 recipe mới bằng Bedrock AI với context đầy đủ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 4. Return 5 suggestions (4 DB + 1 AI)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">suggestRecipes</span>(<span style="color:#a6e22e">userIngredients</span>, <span style="color:#a6e22e">userPreferences</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 1: Validate ingredients với master_ingredients
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validatedIngredients</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">validateIngredientsWithMaster</span>(<span style="color:#a6e22e">userIngredients</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">validatedIngredients</span>.<span style="color:#a6e22e">isValid</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">statusCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">400</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">error</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;ingredient_not_found&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Một số nguyên liệu không hợp lệ&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">invalid_ingredients</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">validatedIngredients</span>.<span style="color:#a6e22e">invalidItems</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">suggestions</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">validatedIngredients</span>.<span style="color:#a6e22e">suggestions</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 2: Query user preferences từ user_data table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">userContext</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">getUserContext</span>(<span style="color:#a6e22e">userPreferences</span>.<span style="color:#a6e22e">userId</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 3: Query 4 approved recipes từ DynamoDB matching user preferences
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dbRecipes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">queryApprovedRecipesByIngredientsAndPreferences</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">validatedIngredients</span>.<span style="color:#a6e22e">ingredients</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userContext</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 4: Generate 1 AI recipe với context đầy đủ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">aiRecipe</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">generateAIRecipe</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">validatedIngredients</span>.<span style="color:#a6e22e">ingredients</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userContext</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 5: Save AI suggestion to history
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">saveAISuggestion</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">userId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userPreferences</span>.<span style="color:#a6e22e">userId</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingredients</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">validatedIngredients</span>.<span style="color:#a6e22e">ingredients</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">aiRecipe</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dbRecipes</span>
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 6: Return combined results
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">statusCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">recipes</span><span style="color:#f92672">:</span> [...<span style="color:#a6e22e">dbRecipes</span>, <span style="color:#a6e22e">aiRecipe</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">stats</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">database_recipes</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">dbRecipes</span>.<span style="color:#a6e22e">length</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ai_recipes</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Lấy thông tin người dùng từ user_data &amp; user_preferences
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getUserContext</span>(<span style="color:#a6e22e">userId</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Query user_data cho sở thích món ăn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">userDataResult</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">QueryCommand</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">KeyConditionExpression</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;PK = :pk AND SK = :sk&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ExpressionAttributeValues</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:pk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`USER#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:sk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;PREFERENCES&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Query user profile cho thông tin cá nhân (năm sinh, giới tính, quốc gia)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">userProfileResult</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">QueryCommand</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">KeyConditionExpression</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;PK = :pk AND SK = :sk&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ExpressionAttributeValues</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:pk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`USER#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:sk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;METADATA&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">userData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">userDataResult</span>.<span style="color:#a6e22e">Items</span><span style="color:#f92672">?</span>.[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">||</span> {};
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">userProfile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">userProfileResult</span>.<span style="color:#a6e22e">Items</span><span style="color:#f92672">?</span>.[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">||</span> {};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Sở thích món ăn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">preferred_cooking_methods</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userData</span>.<span style="color:#a6e22e">preferred_cooking_methods</span> <span style="color:#f92672">||</span> [],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">preferred_meal_types</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userData</span>.<span style="color:#a6e22e">preferred_meal_types</span> <span style="color:#f92672">||</span> [],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">favorite_cuisines</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userData</span>.<span style="color:#a6e22e">favorite_cuisines</span> <span style="color:#f92672">||</span> [],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">allergies</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userData</span>.<span style="color:#a6e22e">allergies</span> <span style="color:#f92672">||</span> [],
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Thông tin cá nhân (cho personalization)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">birth_year</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userProfile</span>.<span style="color:#a6e22e">birth_year</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gender</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userProfile</span>.<span style="color:#a6e22e">gender</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">country</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userProfile</span>.<span style="color:#a6e22e">country</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Mở rộng: món yêu thích quốc gia
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// VD: nếu country = &#34;Vietnam&#34; → ưu tiên món Việt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//     nếu favorite_cuisines = [&#34;Italy&#34;] → ưu tiên món Ý
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">cuisine_preference</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">determineCuisinePreference</span>(<span style="color:#a6e22e">userProfile</span>, <span style="color:#a6e22e">userData</span>)
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Xác định ưu tiên món quốc gia
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">determineCuisinePreference</span>(<span style="color:#a6e22e">profile</span>, <span style="color:#a6e22e">userData</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ưu tiên 1: món yêu thích được chọn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">userData</span>.<span style="color:#a6e22e">favorite_cuisines</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">userData</span>.<span style="color:#a6e22e">favorite_cuisines</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">userData</span>.<span style="color:#a6e22e">favorite_cuisines</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ưu tiên 2: món của quốc gia người dùng
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">profile</span>.<span style="color:#a6e22e">country</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">countryToCuisine</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Vietnam&#39;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;Vietnamese&#39;</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Italy&#39;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;Italian&#39;</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Japan&#39;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;Japanese&#39;</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Thailand&#39;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;Thai&#39;</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Korea&#39;</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;Korean&#39;</span>]
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">countryToCuisine</span>[<span style="color:#a6e22e">profile</span>.<span style="color:#a6e22e">country</span>] <span style="color:#f92672">||</span> [];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> [];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Validate ingredients với master_ingredients table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">validateIngredientsWithMaster</span>(<span style="color:#a6e22e">ingredients</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validated</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">invalid</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">suggestions</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ing</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">ingredients</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Normalize input
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">normalized</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">normalizeText</span>(<span style="color:#a6e22e">ing</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check exact match trong master_ingredients
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exactMatch</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">QueryCommand</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">IndexName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GSI1&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">KeyConditionExpression</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GSI1PK = :pk AND begins_with(GSI1SK, :sk)&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">ExpressionAttributeValues</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;:pk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`INGREDIENT#SEARCH`</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;:sk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`NAME#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">normalized</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">exactMatch</span>.<span style="color:#a6e22e">Items</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">exactMatch</span>.<span style="color:#a6e22e">Items</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">validated</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">exactMatch</span>.<span style="color:#a6e22e">Items</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">name</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Fuzzy search for similar ingredients
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">similar</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fuzzySearchIngredients</span>(<span style="color:#a6e22e">normalized</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">invalid</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">ing</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">suggestions</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">original</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ing</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">similar</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">similar</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>) <span style="color:#75715e">// Top 5 suggestions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">isValid</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">invalid</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ingredients</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">validated</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">invalidItems</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">invalid</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">suggestions</span>
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Fuzzy search cho nguyên liệu tương tự
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fuzzySearchIngredients</span>(<span style="color:#a6e22e">searchTerm</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Scan master_ingredients với filter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">QueryCommand</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">IndexName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GSI1&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">KeyConditionExpression</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GSI1PK = :pk&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FilterExpression</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;contains(normalized_name, :term) OR contains(aliases, :term)&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ExpressionAttributeValues</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:pk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`INGREDIENT#ACTIVE`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:term&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">searchTerm</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Items</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">item</span> =&gt; <span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">name</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Query approved recipes matching ingredients AND user preferences
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">queryApprovedRecipesByIngredientsAndPreferences</span>(<span style="color:#a6e22e">ingredients</span>, <span style="color:#a6e22e">userContext</span>, <span style="color:#a6e22e">limit</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Query recipes theo nguyên liệu và sở thích
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">recipes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">QueryCommand</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">IndexName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GSI2&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">KeyConditionExpression</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GSI2PK = :pk&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FilterExpression</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;is_approved = :approved&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ExpressionAttributeValues</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:pk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`RECIPES#APPROVED`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:approved&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ScanIndexForward</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">// Sắp xếp theo rating cao nhất
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">filteredRecipes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">recipes</span>.<span style="color:#a6e22e">Items</span> <span style="color:#f92672">||</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Filter theo món yêu thích quốc gia (nếu có)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">cuisine_preference</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">cuisine_preference</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cuisineMatches</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">filteredRecipes</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">recipe</span> =&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">cuisine_preference</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#a6e22e">recipe</span>.<span style="color:#a6e22e">cuisine_type</span>)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Nếu có món khớp quốc gia, ưu tiên chúng
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cuisineMatches</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">filteredRecipes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cuisineMatches</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Filter theo sở thích cooking methods (canh, món chiên, món hấp...)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">preferred_cooking_methods</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">preferred_cooking_methods</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filteredRecipes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">filteredRecipes</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">recipe</span> =&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">preferred_cooking_methods</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#a6e22e">recipe</span>.<span style="color:#a6e22e">cooking_method</span>)
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Filter tránh dị ứng
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">allergies</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">allergies</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filteredRecipes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">filteredRecipes</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">recipe</span> =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">recipeIngredients</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">recipe</span>.<span style="color:#a6e22e">ingredients</span> <span style="color:#f92672">||</span> [];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">recipeIngredients</span>.<span style="color:#a6e22e">some</span>(<span style="color:#a6e22e">ing</span> =&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">allergies</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#a6e22e">ing</span>.<span style="color:#a6e22e">ingredient_name</span>)
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">filteredRecipes</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">limit</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Normalize text (bỏ dấu, lowercase)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">normalizeText</span>(<span style="color:#a6e22e">text</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">text</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">toLowerCase</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">normalize</span>(<span style="color:#e6db74">&#39;NFD&#39;</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/[\u0300-\u036f]/g</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">trim</span>();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><strong>AI Agent Prompt &amp; Privacy Policy:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Generate AI recipe với context đầy đủ + privacy protection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">generateAIRecipe</span>(<span style="color:#a6e22e">ingredients</span>, <span style="color:#a6e22e">userContext</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bedrockClient</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BedrockRuntimeClient</span>({ <span style="color:#a6e22e">region</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;us-east-1&#39;</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ===== PRIVACY POLICY =====
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Dữ liệu được sử dụng cho personalization:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// ✅ Năm sinh (birth_year) - để tính tuổi và khuyến nghị dinh dưỡng phù hợp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// ✅ Giới tính (gender) - để khuyến nghị khẩu phần và dinh dưỡng
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// ✅ Quốc gia (country) - để gợi ý món ăn địa phương/quốc gia
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// ✅ Sở thích món (preferred_cooking_methods, favorite_cuisines)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// ✅ Dị ứng (allergies) - QUAN TRỌNG để an toàn thực phẩm
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// ❌ KHÔNG sử dụng:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// - Email, số điện thoại, địa chỉ cụ thể
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// - Tên đầy đủ hoặc thông tin định danh cá nhân khác
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Mục đích: Cá nhân hóa gợi ý món ăn, KHÔNG theo dõi hoặc khai thác thông tin cá nhân
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Tính tuổi từ năm sinh (nếu có)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">age</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">birth_year</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">getFullYear</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">birth_year</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Tạo prompt cho AI với context đầy đủ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">prompt</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`Bạn là một đầu bếp chuyên nghiệp. Hãy tạo một công thức nấu ăn sáng tạo dựa trên thông tin sau:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">**Nguyên liệu có sẵn:**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#e6db74">${</span><span style="color:#a6e22e">ingredients</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">ing</span> =&gt; <span style="color:#e6db74">`- </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">ing</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>).<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">**Thông tin người dùng (để cá nhân hóa):**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#e6db74">${</span><span style="color:#a6e22e">age</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">`- Tuổi: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">age</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> tuổi (khuyến nghị dinh dưỡng phù hợp)`</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">gender</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">`- Giới tính: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">gender</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> (khẩu phần phù hợp)`</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">country</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">`- Quốc gia: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">country</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> (gợi ý món địa phương)`</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">**Sở thích món ăn:**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">preferred_cooking_methods</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">?</span> <span style="color:#e6db74">`- Thích: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">preferred_cooking_methods</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;, &#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;- Không có sở thích cụ thể&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">**Món yêu thích quốc gia:**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">cuisine_preference</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">?</span> <span style="color:#e6db74">`- Ưu tiên món: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">cuisine_preference</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;, &#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;- Không có món quốc gia yêu thích&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">**Dị ứng (TRÁNH TUYỆT ĐỐI):**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">allergies</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">?</span> <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">allergies</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">a</span> =&gt; <span style="color:#e6db74">`- ❌ </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">a</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>).<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;- Không có dị ứng&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">**Yêu cầu:**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1. Sử dụng TOÀN BỘ hoặc phần lớn nguyên liệu đã cho
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">2. Nếu người dùng từ </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">country</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, ưu tiên phong cách nấu ăn địa phương
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">3. Nếu thích món </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">cuisine_preference</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;/&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">, tạo món theo hướng đó
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">4. Nếu thích </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">preferred_cooking_methods</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;/&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">, ưu tiên phương pháp đó
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">5. TUYỆT ĐỐI KHÔNG dùng nguyên liệu gây dị ứng: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">allergies</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;, &#39;</span>) <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;Không&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">6. Phù hợp với tuổi </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">age</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">age</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> tuổi`</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;người lớn&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">7. Món ăn sáng tạo, độc đáo, chưa có trong database
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">**Trả về JSON format:**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;name&#34;: &#34;Tên món ăn&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;cuisine_type&#34;: &#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">cuisine_preference</span><span style="color:#f92672">?</span>.[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;Vietnamese&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;cooking_method&#34;: &#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">preferred_cooking_methods</span><span style="color:#f92672">?</span>.[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;nấu&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;meal_type&#34;: &#34;món chính/món phụ/canh&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;difficulty&#34;: &#34;dễ/trung bình/khó&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;cooking_time&#34;: &#34;30 phút&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;servings&#34;: 2,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;ingredients&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;ingredient_name&#34;: &#34;Tên nguyên liệu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;quantity&#34;: &#34;100g&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;preparation&#34;: &#34;Cắt nhỏ&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;instructions&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;step_number&#34;: 1,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;description&#34;: &#34;Mô tả bước làm&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;duration&#34;: &#34;5 phút&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;nutritional_info&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;calories&#34;: 300,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;protein&#34;: &#34;20g&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;carbs&#34;: &#34;30g&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;fat&#34;: &#34;10g&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;tags&#34;: [&#34;healthy&#34;, &#34;quick&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;notes&#34;: &#34;Phù hợp cho người </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">age</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">age</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> tuổi`</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;người lớn&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">bedrockClient</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">InvokeModelCommand</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">modelId</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;anthropic.claude-3-haiku-20240307-v1:0&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">contentType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;application/json&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">accept</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;application/json&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">anthropic_version</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;bedrock-2023-05-31&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">max_tokens</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2048</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">messages</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">role</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;user&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">prompt</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>    }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">responseBody</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TextDecoder</span>().<span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">body</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">aiRecipeJSON</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">responseBody</span>.<span style="color:#a6e22e">content</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">text</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Thêm metadata cho AI-generated recipe
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">aiRecipe</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      ...<span style="color:#a6e22e">aiRecipeJSON</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">recipe_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`ai-gen-</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">generateUUID</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">source</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;ai&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">is_new</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">is_approved</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">created_by</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;bedrock-ai&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">created_at</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>(),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Privacy metadata: Log rằng đã sử dụng thông tin cá nhân (cho audit)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">personalization_used</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">age_range</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">age</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span>Math.<span style="color:#a6e22e">floor</span>(<span style="color:#a6e22e">age</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">10</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span><span style="color:#e6db74">}</span><span style="color:#e6db74">-</span><span style="color:#e6db74">${</span>Math.<span style="color:#a6e22e">floor</span>(<span style="color:#a6e22e">age</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">10</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">9</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">gender</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">gender</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">country</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">country</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cuisine_preference</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">cuisine_preference</span> <span style="color:#f92672">||</span> [],
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">allergies_avoided</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userContext</span>.<span style="color:#a6e22e">allergies</span> <span style="color:#f92672">||</span> []
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">aiRecipe</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#39;AI Recipe Generation Error:&#39;</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Failed to generate AI recipe&#39;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><strong>Lambda Recipe Rating Handler:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Auto-approval dựa trên rating (&gt;= 4 sao)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">handleRecipeRating</span>(<span style="color:#a6e22e">recipeId</span>, <span style="color:#a6e22e">userId</span>, <span style="color:#a6e22e">rating</span>, <span style="color:#a6e22e">comment</span>, <span style="color:#a6e22e">historyId</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Validate rating (1-5)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">rating</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">rating</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">5</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">statusCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">400</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">error</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Invalid rating. Must be 1-5.&#39;</span> }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 1: Save rating to recipe_ratings table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">PutCommand</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Item</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">PK</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`RECIPE#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">recipeId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">SK</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`RATING#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rating_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">generateUUID</span>(),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">recipe_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">recipeId</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">user_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userId</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rating</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">comment</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">history_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">historyId</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">is_verified_cook</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">historyId</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">created_at</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>(),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">updated_at</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 2: Update user_cooking_history với personal_rating
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">historyId</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">PutCommand</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Item</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">PK</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`USER#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">SK</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`COOKING#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">historyId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">personal_rating</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rating</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">updated_at</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>()
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 3: Calculate average rating cho recipe
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">avgRating</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">calculateAverageRating</span>(<span style="color:#a6e22e">recipeId</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ratingCount</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">getRatingCount</span>(<span style="color:#a6e22e">recipeId</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 4: Auto-approve if &gt;= 4.0 stars
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">avgRating</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">4.0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">PutCommand</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Item</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">PK</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`RECIPE#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">recipeId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">SK</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;METADATA&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">is_approved</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">is_public</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">approval_type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;auto_rating&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">average_rating</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">avgRating</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rating_count</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ratingCount</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">approved_at</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>(),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">updated_at</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>()
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">statusCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">success</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rating_saved</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">average_rating</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">avgRating</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rating_count</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ratingCount</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">auto_approved</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Công thức đã được thêm vào database tổng!&#39;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Step 5: Rating &lt; 4.0 - chỉ cảm ơn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">statusCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">success</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rating_saved</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">average_rating</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">avgRating</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rating_count</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ratingCount</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">auto_approved</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Cảm ơn đánh giá của bạn!&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Calculate average rating
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">calculateAverageRating</span>(<span style="color:#a6e22e">recipeId</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">QueryCommand</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">KeyConditionExpression</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;PK = :pk AND begins_with(SK, :sk)&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ExpressionAttributeValues</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:pk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`RECIPE#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">recipeId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:sk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;RATING#&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Items</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Items</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">total</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Items</span>.<span style="color:#a6e22e">reduce</span>((<span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">item</span>) =&gt; <span style="color:#a6e22e">sum</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">rating</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (<span style="color:#a6e22e">total</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Items</span>.<span style="color:#a6e22e">length</span>).<span style="color:#a6e22e">toFixed</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Get rating count
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getRatingCount</span>(<span style="color:#a6e22e">recipeId</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">QueryCommand</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">KeyConditionExpression</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;PK = :pk AND begins_with(SK, :sk)&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ExpressionAttributeValues</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:pk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`RECIPE#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">recipeId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:sk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;RATING#&#39;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Select</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;COUNT&#39;</span>
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Count</span> <span style="color:#f92672">||</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><strong>Lambda Cooking History Handler:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Quản lý lịch sử nấu ăn cá nhân
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">startCooking</span>(<span style="color:#a6e22e">userId</span>, <span style="color:#a6e22e">recipeId</span>, <span style="color:#a6e22e">suggestionId</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">historyId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">generateUUID</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">PutCommand</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Item</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">PK</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`USER#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">SK</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`COOKING#</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">historyId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">history_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">historyId</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">user_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userId</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">recipe_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">recipeId</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">suggestion_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">suggestionId</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;cooking&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">created_at</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>(),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">updated_at</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">statusCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">history_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">historyId</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Bắt đầu nấu ăn!&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Hoàn thành nấu ăn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">completeCooking</span>(<span style="color:#a6e22e">historyId</span>, <span style="color:#a6e22e">userId</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">PutCommand</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Item</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">PK</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`USER#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">SK</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`COOKING#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">historyId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;completed&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">cook_date</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>(),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">updated_at</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">statusCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Hoàn thành! Vui lòng đánh giá món ăn.&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">show_rating_form</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Lấy lịch sử nấu ăn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getCookingHistory</span>(<span style="color:#a6e22e">userId</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ddb</span>.<span style="color:#a6e22e">send</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">QueryCommand</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TableName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;smart-cooking-data&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">KeyConditionExpression</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;PK = :pk AND begins_with(SK, :sk)&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ExpressionAttributeValues</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:pk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`USER#</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">userId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;:sk&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;COOKING#&#39;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ScanIndexForward</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">// Newest first
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">statusCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">history</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Items</span> <span style="color:#f92672">||</span> []
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><strong>Dịch Vụ Chính:</strong></p>
<ul>
<li><strong>Amazon Bedrock</strong>: Claude 3 Haiku model</li>
<li><strong>DynamoDB</strong>: Lưu trữ dữ liệu người dùng &amp; gợi ý AI</li>
<li><strong>Lambda</strong>: Serverless compute (Node.js 20)</li>
<li><strong>API Gateway</strong>: REST API endpoints</li>
</ul>
<h3 id="cơ-sở-dữ-liệu-amazon-dynamodb">Cơ Sở Dữ Liệu: Amazon DynamoDB<a class="anchor" href="#c%c6%a1-s%e1%bb%9f-d%e1%bb%af-li%e1%bb%87u-amazon-dynamodb">#</a></h3>
<p><strong>Các Bảng Sử Dụng:</strong></p>
<ul>
<li><code>Users</code> (PK: user_id) - Hồ sơ &amp; vai trò</li>
<li><code>UserData</code> (PK: user_id, SK: PREFERENCES | INGREDIENTS) - Cài đặt người dùng</li>
<li><code>Recipes</code> (PK: recipe_id) - Công thức (có thêm field is_approved, approval_type, average_rating)</li>
<li><code>RecipeRatings</code> (PK: recipe_id, SK: user_id) - Đánh giá công thức cho auto-approval</li>
<li><code>UserCookingHistory</code> (PK: user_id, SK: timestamp) - Lịch sử nấu ăn cá nhân (thay thế favorites)</li>
<li><code>MasterIngredients</code> (PK: ingredient_id) - Master list nguyên liệu để validate</li>
<li><code>PrivacySettings</code> (PK: user_id) - Cấu hình quyền riêng tư</li>
<li><code>Friendships</code> (PK: user_id, SK: friend_id) - Kết nối xã hội</li>
<li><code>AISuggestions</code> (PK: user_id, SK: timestamp) - Lịch sử AI</li>
</ul>
<p><strong>Triển Khai Quyền Riêng Tư:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Bộ lọc quyền riêng tư áp dụng trước khi trả về dữ liệu người dùng
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">privacy</span>.<span style="color:#a6e22e">ingredients_visibility</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;friends&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">isFriend</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">userProfile</span>.<span style="color:#a6e22e">ingredients</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="api-endpoints">API Endpoints<a class="anchor" href="#api-endpoints">#</a></h3>
<p><strong>Luồng Gợi Ý AI (Enhanced - Flexible Mix):</strong></p>
<pre tabindex="0"><code>POST /ai/suggest
Authorization: Bearer &lt;JWT&gt;
Body: {
  &#34;ingredients&#34;: [&#34;thịt gà&#34;, &#34;cà chua&#34;, &#34;hành&#34;],
  &#34;recipe_count&#34;: 3  // NEW: 1-5 món (default: 1)
}

Response (Success - Flexible mix):
{
  &#34;suggestions&#34;: [
    {
      &#34;id&#34;: &#34;recipe-001&#34;,
      &#34;name&#34;: &#34;Gà xào cà chua&#34;,
      &#34;source&#34;: &#34;database&#34;,
      &#34;cooking_method&#34;: &#34;xào&#34;,  // NEW
      &#34;meal_type&#34;: &#34;món chính&#34;,  // NEW
      &#34;match_score&#34;: 0.95,
      &#34;is_approved&#34;: true,
      &#34;average_rating&#34;: 4.5
    },
    {
      &#34;id&#34;: &#34;recipe-002&#34;,
      &#34;name&#34;: &#34;Canh cà chua&#34;,
      &#34;source&#34;: &#34;database&#34;,
      &#34;cooking_method&#34;: &#34;canh&#34;,  // NEW - Diverse!
      &#34;meal_type&#34;: &#34;canh&#34;,
      &#34;match_score&#34;: 0.80,
      &#34;is_approved&#34;: true,
      &#34;average_rating&#34;: 4.2
    },
    {
      &#34;id&#34;: &#34;ai-gen-001&#34;,
      &#34;name&#34;: &#34;Gà hấp cà chua hành&#34;,
      &#34;source&#34;: &#34;ai&#34;,
      &#34;cooking_method&#34;: &#34;hấp&#34;,  // NEW - Diverse!
      &#34;meal_type&#34;: &#34;món chính&#34;,
      &#34;is_new&#34;: true,
      &#34;is_approved&#34;: false,
      &#34;ingredients&#34;: [...],
      &#34;instructions&#34;: [...]
    }
  ],
  &#34;stats&#34;: {
    &#34;requested&#34;: 3,  // NEW
    &#34;from_database&#34;: 2,  // NEW - Flexible!
    &#34;from_ai&#34;: 1  // NEW - Only 1 AI call needed!
  },
  &#34;warnings&#34;: []  // NEW - Empty if all ingredients valid
}

Response (Warning - Invalid ingredient but still work):
{
  &#34;suggestions&#34;: [...],  // Still return results
  &#34;stats&#34;: {
    &#34;requested&#34;: 3,
    &#34;from_database&#34;: 0,  // Not enough valid ingredients for DB
    &#34;from_ai&#34;: 3  // AI handles it
  },
  &#34;warnings&#34;: [  // NEW
    {
      &#34;ingredient&#34;: &#34;abc xyz&#34;,
      &#34;message&#34;: &#34;Nguyên liệu không hợp lệ, AI sẽ cố gắng xử lý&#34;,
      &#34;suggestions&#34;: [&#34;gà&#34;, &#34;cá&#34;, &#34;bò&#34;],
      &#34;reported&#34;: true  // Đã log để admin review
    }
  ]
}

Response (Error - All invalid):
{
  &#34;error&#34;: &#34;all_ingredients_invalid&#34;,
  &#34;message&#34;: &#34;Tất cả nguyên liệu không hợp lệ. Vui lòng nhập lại.&#34;,
  &#34;invalid_ingredients&#34;: [&#34;abc&#34;, &#34;xyz&#34;, &#34;123&#34;],
  &#34;suggestions&#34;: [
    { &#34;original&#34;: &#34;abc&#34;, &#34;similar&#34;: [&#34;cá&#34;, &#34;gà&#34;] },
    { &#34;original&#34;: &#34;xyz&#34;, &#34;similar&#34;: [&#34;rau&#34;, &#34;củ&#34;] }
  ]
}</code></pre><p><strong>Luồng Cooking History:</strong></p>
<pre tabindex="0"><code>POST /cooking/start
Authorization: Bearer &lt;JWT&gt;
Body: {
  &#34;recipe_id&#34;: &#34;ai-gen-001&#34;,
  &#34;suggestion_id&#34;: &#34;suggestion-123&#34;
}

Response:
{
  &#34;history_id&#34;: &#34;history-001&#34;,
  &#34;message&#34;: &#34;Bắt đầu nấu ăn!&#34;
}

PUT /cooking/{history_id}/complete
Authorization: Bearer &lt;JWT&gt;

Response:
{
  &#34;message&#34;: &#34;Hoàn thành! Vui lòng đánh giá món ăn.&#34;,
  &#34;show_rating_form&#34;: true
}

GET /user/cooking-history
Authorization: Bearer &lt;JWT&gt;

Response:
{
  &#34;history&#34;: [
    {
      &#34;history_id&#34;: &#34;history-001&#34;,
      &#34;recipe_id&#34;: &#34;ai-gen-001&#34;,
      &#34;status&#34;: &#34;completed&#34;,
      &#34;personal_rating&#34;: 5,
      &#34;is_favorite&#34;: true,
      &#34;cook_date&#34;: &#34;2025-10-03T10:30:00Z&#34;
    },
    ...
  ]
}</code></pre><p><strong>Luồng Rating &amp; Auto-Approval:</strong></p>
<pre tabindex="0"><code>POST /recipes/{id}/rate
Authorization: Bearer &lt;JWT&gt;
Body: {
  &#34;rating&#34;: 5,
  &#34;comment&#34;: &#34;Món này rất ngon!&#34;,
  &#34;history_id&#34;: &#34;history-001&#34;
}

Response (Auto-approved):
{
  &#34;success&#34;: true,
  &#34;rating_saved&#34;: true,
  &#34;average_rating&#34;: 4.2,
  &#34;rating_count&#34;: 15,
  &#34;auto_approved&#34;: true,
  &#34;message&#34;: &#34;Công thức đã được thêm vào database!&#34;,
  &#34;recipe&#34;: {
    &#34;id&#34;: &#34;ai-gen-001&#34;,
    &#34;is_approved&#34;: true,
    &#34;is_public&#34;: true,
    &#34;approval_type&#34;: &#34;auto_rating&#34;
  }
}

Response (Not approved):
{
  &#34;success&#34;: true,
  &#34;rating_saved&#34;: true,
  &#34;average_rating&#34;: 3.5,
  &#34;rating_count&#34;: 8,
  &#34;auto_approved&#34;: false,
  &#34;message&#34;: &#34;Cảm ơn đánh giá của bạn!&#34;
}</code></pre><p><strong>Luồng Validate Ingredients:</strong></p>
<pre tabindex="0"><code>POST /ingredients/validate
Authorization: Bearer &lt;JWT&gt;
Body: {
  &#34;ingredients&#34;: [&#34;cá rô&#34;, &#34;abc xyz&#34;, &#34;thit ga&#34;]
}

Response:
{
  &#34;valid&#34;: [&#34;cá rô&#34;],
  &#34;invalid&#34;: [&#34;abc xyz&#34;],
  &#34;corrected&#34;: [
    {
      &#34;original&#34;: &#34;thit ga&#34;,
      &#34;matched&#34;: &#34;thịt gà&#34;,
      &#34;confidence&#34;: 0.85
    }
  ],
  &#34;suggestions&#34;: [
    {
      &#34;original&#34;: &#34;abc xyz&#34;,
      &#34;similar&#34;: [&#34;gà&#34;, &#34;cá&#34;, &#34;bò&#34;, &#34;tôm&#34;, &#34;mực&#34;]
    }
  ]
}</code></pre><p><strong>Endpoints Quyền Riêng Tư &amp; Xã Hội:</strong></p>
<pre tabindex="0"><code>PUT /user/privacy - Cập nhật cài đặt quyền riêng tư
GET /user/profile/{userId} - Lấy hồ sơ (đã lọc quyền riêng tư)
POST /friends/request - Gửi yêu cầu kết bạn
GET /friends - Danh sách bạn bè</code></pre><p><strong>Endpoints Quản Trị:</strong></p>
<pre tabindex="0"><code>GET /admin/users - Danh sách tất cả người dùng (chỉ admin)
PUT /admin/users/{id}/ban - Cấm người dùng (chỉ admin)
GET /admin/statistics - Thống kê hệ thống (chỉ admin)
GET /admin/recipes/pending - Công thức chờ approval (ít sử dụng do auto-approval)</code></pre><p><strong>Endpoints Mới - Social Features:</strong></p>
<pre tabindex="0"><code>POST /posts - Tạo bài đăng
GET /posts/feed - Lấy newsfeed
POST /posts/{id}/comments - Bình luận
POST /reactions - Thêm reaction
GET /notifications - Lấy thông báo</code></pre><h2 id="quyền-riêng-tư--bảo-mật">QUYỀN RIÊNG TƯ &amp; BẢO MẬT<a class="anchor" href="#quy%e1%bb%81n-ri%c3%aang-t%c6%b0--b%e1%ba%a3o-m%e1%ba%adt">#</a></h2>
<h3 id="các-mức-quyền-riêng-tư">Các Mức Quyền Riêng Tư<a class="anchor" href="#c%c3%a1c-m%e1%bb%a9c-quy%e1%bb%81n-ri%c3%aang-t%c6%b0">#</a></h3>
<ul>
<li><strong>Public</strong>: Mọi người có thể xem</li>
<li><strong>Friends</strong>: Chỉ bạn bè đã chấp nhận có thể xem</li>
<li><strong>Private</strong>: Chỉ người dùng có thể xem</li>
</ul>
<h3 id="thuộc-tính-được-kiểm-soát-quyền-riêng-tư">Thuộc Tính Được Kiểm Soát Quyền Riêng Tư<a class="anchor" href="#thu%e1%bb%99c-t%c3%adnh-%c4%91%c6%b0%e1%bb%a3c-ki%e1%bb%83m-so%c3%a1t-quy%e1%bb%81n-ri%c3%aang-t%c6%b0">#</a></h3>
<ul>
<li>Email (mặc định: private)</li>
<li>Ngày sinh (mặc định: friends)</li>
<li>Giới tính (mặc định: public)</li>
<li>Quốc gia (mặc định: public)</li>
<li>Công thức (mặc định: public)</li>
<li>Nguyên liệu (mặc định: friends)</li>
<li>Sở thích (mặc định: friends)</li>
</ul>
<h3 id="kiểm-soát-truy-cập-theo-vai-trò">Kiểm Soát Truy Cập Theo Vai Trò<a class="anchor" href="#ki%e1%bb%83m-so%c3%a1t-truy-c%e1%ba%adp-theo-vai-tr%c3%b2">#</a></h3>
<ul>
<li><strong>User</strong>: Truy cập thông thường</li>
<li><strong>Admin</strong>: Truy cập đầy đủ + công cụ quản trị</li>
</ul>
<h2 id="thời-gian--mốc-quan-trọng">Thời Gian &amp; Mốc Quan Trọng<a class="anchor" href="#th%e1%bb%9di-gian--m%e1%bb%91c-quan-tr%e1%bb%8dng">#</a></h2>
<p>Xem <a href="../customer-deployment-guide">Hướng Dẫn Triển Khai Khách Hàng</a> để biết thời gian chi tiết.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

<div>

</div>

<div>

</div>

</div>





  
  
  
  <div class="flex flex-wrap justify-between">
    <span>
    
      <a href="/docs/summary/aws-services-diagram/" class="flex align-center">
        <img src="/icons/backward.svg" class="book-icon" alt="Previous" title="AWS Services Architecture Diagram" />
        <span>AWS Services Architecture Diagram</span>
      </a>
    
    </span>
    <span>
    
      <a href="/docs/summary/database-diagram/" class="flex align-center">
        <span>Database Schema Diagram</span>
        <img src="/icons/forward.svg" class="book-icon" alt="Next" title="Database Schema Diagram" />
      </a>
    
    </span>
  </div>
  




  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
  
  <div class="book-comments">

</div>
  
 
        
        

 
      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    

<aside class="book-toc">
  <div class="book-toc-content">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#tổng-quan">TỔNG QUAN</a></li>
    <li><a href="#luồng-người-dùng">LUỒNG NGƯỜI DÙNG</a>
      <ul>
        <li><a href="#flow-1-gợi-ý-món-ăn-thông-minh-smart-suggestion">Flow 1: Gợi Ý Món Ăn Thông Minh (Smart Suggestion)</a></li>
        <li><a href="#flow-2-auto-approval-công-thức-rating-based">Flow 2: Auto-Approval Công Thức (Rating-based)</a></li>
        <li><a href="#flow-3-error-handling---nguyên-liệu-không-hợp-lệ">Flow 3: Error Handling - Nguyên Liệu Không Hợp Lệ</a></li>
      </ul>
    </li>
    <li><a href="#triển-khai-kỹ-thuật">TRIỂN KHAI KỸ THUẬT</a>
      <ul>
        <li><a href="#kiến-trúc-tables--relationships">Kiến Trúc Tables &amp; Relationships</a></li>
        <li><a href="#backend-nodejs-20-lambda-functions">Backend: Node.js 20 Lambda Functions</a></li>
        <li><a href="#cơ-sở-dữ-liệu-amazon-dynamodb">Cơ Sở Dữ Liệu: Amazon DynamoDB</a></li>
        <li><a href="#api-endpoints">API Endpoints</a></li>
      </ul>
    </li>
    <li><a href="#quyền-riêng-tư--bảo-mật">QUYỀN RIÊNG TƯ &amp; BẢO MẬT</a>
      <ul>
        <li><a href="#các-mức-quyền-riêng-tư">Các Mức Quyền Riêng Tư</a></li>
        <li><a href="#thuộc-tính-được-kiểm-soát-quyền-riêng-tư">Thuộc Tính Được Kiểm Soát Quyền Riêng Tư</a></li>
        <li><a href="#kiểm-soát-truy-cập-theo-vai-trò">Kiểm Soát Truy Cập Theo Vai Trò</a></li>
      </ul>
    </li>
    <li><a href="#thời-gian--mốc-quan-trọng">Thời Gian &amp; Mốc Quan Trọng</a></li>
  </ul>
</nav>



  </div>
</aside>

 
  </main>

  
</body>
</html>


















